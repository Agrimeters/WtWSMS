###############################
# Foederati events
#
# 
###############################

namespace = WtWSMS_foederati

# Romans accept or refuse to start negotiating with barbarian
character_event = {
	id = WtWSMS_foederati.1
	desc = WtWSMS_foederati.1.desc
	picture = GFX_evt_emissary
	
	is_triggered_only = yes
	
	immediate = {
		FROM = {
			save_event_target_as = barbarian_negotiator
		}
		ROOT = {
			save_event_target_as = roman_negotiator
		}
	}
	
	option = { # Yes
		name = WtWSMS_foederati.1.a
		ai_chance = {
			#Option A modifiers
		}
		event_target:barbarian_negotiator = {
			character_event = { 
				id = WtWSMS_foederati.2 # Negotiations begin - settle in empire or not?
				days = 7
				random = 3
			}
		}
	}
    option = { # No, negotiations break
		name = WtWSMS_foederati.1.b
		ai_chance = {
			#Option B modifiers
		}
		event_target:barbarian_negotiator = {
			character_event = { 
				id = WtWSMS_foederati.12 # Negotiations break
				days = 7
				random = 3
			}
		}
	}
}

# Negotiations begin - settle in empire or not?
character_event = {
    id = WtWSMS_foederati.2
	desc = WtWSMS_foederati.2.desc
	picture = GFX_evt_emissary
	
    is_triggered_only = yes

	option = { # Yes
		name = WtWSMS_foederati.2.a
		ai_chance = {
			#Option A modifiers
		}
		event_target:roman_negotiator = {
			character_event = { 
				id = WtWSMS_foederati.3 # Barbarian negotiator wishes to settle in the empire
				days = 7
				random = 3
			}
		}
	}
	option = { # No
		name = WtWSMS_foederati.2.b
		ai_chance = {
			#Option B modifiers
		}
		event_target:roman_negotiator = {
			character_event = { 
				id = WtWSMS_foederati.11 # Barbarian negotiator does not wish to settle in the empire
				days = 7
				random = 3
			}
		}
	}
}	

# Barbarian negotiator wishes to settle in the empire
character_event = {
    id = WtWSMS_foederati.3
	desc = WtWSMS_foederati.3.desc
	picture = GFX_evt_emissary
	
    is_triggered_only = yes

	option = { # Accept it and offer a territory
		name = WtWSMS_foederati.3.a
		ai_chance = {
			#Option A modifiers
		}
		event_target:roman_negotiator = {
			character_event = { 
				id = WtWSMS_foederati.4 # Pick a territory to offer
			}			
			set_character_flag = offered_territory_flag
		}
	}
	option = { # Accept it and promise a territory
		name = WtWSMS_foederati.3.b
		ai_chance = {
			#Option B modifiers
		}
		event_target:roman_negotiator = {
			character_event = { 
				id = WtWSMS_foederati.7 # Pick a territory to promise
			}
			set_character_flag = promised_territory_to_@FROM_flag
		}
	}
	option = { # Refuse to grant territory within the empire, offer to settle outside it
		name = WtWSMS_foederati.3.c
		ai_chance = {
			#Option C modifiers
		}
		event_target:barbarian_negotiator = {
			character_event = { 
				id = WtWSMS_foederati.10 # Makes the offer to settle outside it
			}
		}
		event_target:roman_negotiator = {
			set_character_flag = settling_outside_empire_flag
		}
	}
}	

# Pick a territory to offer
character_event = {
    id = WtWSMS_foederati.4
	desc = WtWSMS_foederati.4.desc
	picture = GFX_evt_emissary
	
    is_triggered_only = yes
	
	immediate = {
		random_realm_title = {
		    limit = {
				tier = duke
				is_titular = no # Dejure duchy
				any_de_jure_vassal = { # Vassal county of the duchy
					is_capital = no # Don't want to hand out the capital duchy
					location = {
						any_neighbor_province = {
							holder_scope = {
								OR = { 
									character = event_target:barbarian_negotiator # Any dejure vassal county of the duchy has a neighbouring county which is held by event_target:barbarian_negotiator
									AND = { # Any dejure vassal county of the duchy has a neighbouring county which is not held by event_target:barbarian_negotiator but still not in the realm
										NOT = { character = event_target:barbarian_negotiator } 
										NOT = { same_realm = event_target:roman_negotiator } 	
									}
								}
							}
						}
					}
				}
    		}
			save_event_target_as = offered_territory
		} 
	}

	option = { # Pick suggested territory
		name = WtWSMS_foederati.4.a
		ai_chance = {
			#Option A modifiers
		}
		event_target:barbarian_negotiator = {
			character_event = { 
				id = WtWSMS_foederati.5 # Makes the offer
				days = 7
				random = 3
			}
		}
	}
	option = { # Find another one than the suggested, reloads same event
		name = WtWSMS_foederati.4.b
		ai_chance = {
			#Option B modifiers
		}
		event_target:roman_negotiator = {
			character_event = { 
				id = WtWSMS_foederati.4 # Pick a territory to offer
			}
		}
		clear_event_target = offered_territory
	}
}

# Makes the offer
character_event = {
    id = WtWSMS_foederati.5
	desc = WtWSMS_foederati.5.desc
	picture = GFX_evt_emissary
	
    is_triggered_only = yes

	option = { # Accept the offer
		name = WtWSMS_foederati.5.a
		ai_chance = {
			#Option A modifiers
		}
		event_target:barbarian_negotiator = {
			character_event = { 				
				id = WtWSMS_foederati.13 # Negotiations successful, with both parties having accepted
			}
			any_realm_province = { # Set flag to give away land
				limit = {
					NOT = { has_province_flag = foederati_give_away }
				}
				set_province_flag = foederati_give_away
			}
		}
		event_target:roman_negotiator = {
			character_event = { 
				id = WtWSMS_foederati.13 # Negotiations successful, with both parties having accepted
				days = 7
				random = 3
			}
		}
	}
	option = { # Refuse the offer
		name = WtWSMS_foederati.5.b
		ai_chance = {
			#Option B modifiers
		}
		clear_event_target = offered_territory
		event_target:roman_negotiator = {
			character_event = { 
				id = WtWSMS_foederati.6 # Barbarian refuses province offer
				days = 7
				random = 3
			}
		}
	}
}	

# Barbarian refuses province offer
character_event = {
    id = WtWSMS_foederati.6
	desc = WtWSMS_foederati.6.desc
	picture = GFX_evt_emissary
	
    is_triggered_only = yes

	option = { # Pick another territory to offer
		name = WtWSMS_foederati.6.a
		ai_chance = {
			#Option A modifiers
		}
		event_target:roman_negotiator = {
			character_event = { 
				id = WtWSMS_foederati.4 # Pick a territory to offer
			}
		}
	}
	option = { 	# Break negotiations
		name = WtWSMS_foederati.6.b
		ai_chance = {
			#Option B modifiers
		}
		event_target:barbarian_negotiator = {
			character_event = { 
				id = WtWSMS_foederati.12 # Negotiations break
				days = 7
				random = 3
			}
		}
		event_target:roman_negotiator = {
			character_event = { 
				id = WtWSMS_foederati.12 # Negotiations break
			}
		}
	}
}

# Pick a territory to promise
character_event = {
    id = WtWSMS_foederati.7
	desc = WtWSMS_foederati.7.desc
	picture = GFX_evt_emissary
	
    is_triggered_only = yes
	
	immediate = {
		random_realm_title = {
		    limit = {
				tier = duke
				is_titular = no # Dejure duchy
				any_de_jure_vassal = { # Vassal county of the duchy
					is_capital = no # Don't want to hand out the capital duchy
					location = {
						any_neighbor_province = {
							holder_scope = {
								OR = { 
									character = event_target:barbarian_negotiator # Any dejure vassal county of the duchy has a neighbouring county which is held by event_target:barbarian_negotiator
									AND = { # Any dejure vassal county of the duchy has a neighbouring county which is not held by event_target:barbarian_negotiator but still not in the realm
										NOT = { character = event_target:barbarian_negotiator } 
										NOT = { same_realm = event_target:roman_negotiator } 	
									}
								}
							}
						}
					}
				}
    		}
			save_event_target_as = promised_territory
		} 
	}

	option = { # Pick suggested territory
		name = WtWSMS_foederati.7.a
		ai_chance = {
			#Option A modifiers
		}
		event_target:barbarian_negotiator = {
			character_event = { 
				id = WtWSMS_foederati.8 # Makes the promise
				days = 7
				random = 3
			}
		}
	}
	option = { # Find another one than the suggested, reloads same event
		name = WtWSMS_foederati.7.b
		ai_chance = {
			#Option B modifiers
		}
		event_target:roman_negotiator = {
			character_event = { 
				id = WtWSMS_foederati.7 # Pick a territory to promise
			}
		}
		clear_event_target = promised_territory
	}
}

# Makes the promise
character_event = {
    id = WtWSMS_foederati.8
	desc = WtWSMS_foederati.8.desc
	picture = GFX_evt_emissary
	
    is_triggered_only = yes

	option = { # Accept the promise
		name = WtWSMS_foederati.8.a
		ai_chance = {
			#Option A modifiers
		}
		event_target:barbarian_negotiator = {
			character_event = { 				
				id = WtWSMS_foederati.13 # Negotiations successful, with both parties having accepted
			}
			any_realm_province = { # Set flag to give away land
				limit = {
					NOT = { has_province_flag = foederati_give_away }
				}
				set_province_flag = foederati_give_away
			}
		}
		event_target:roman_negotiator = {
			character_event = { 
				id = WtWSMS_foederati.13 # Negotiations successful, with both parties having accepted
				days = 7
				random = 3
			}
		}
	}
	option = { # Refuse the promise
		name = WtWSMS_foederati.8.b
		ai_chance = {
			#Option B modifiers
		}
		clear_event_target = promised_territory
		event_target:roman_negotiator = {
			character_event = {
				id = WtWSMS_foederati.9 # Barbarian refuses province promise
				days = 7
				random = 3
			}
		}
	}
}	

# Barbarian refuses province promise
character_event = {
    id = WtWSMS_foederati.9
	desc = WtWSMS_foederati.9.desc
	picture = GFX_evt_emissary
	
    is_triggered_only = yes

	option = { # Pick another territory to promise
		name = WtWSMS_foederati.9.a
		ai_chance = {
			#Option A modifiers
		}
		event_target:roman_negotiator = {
			character_event = { 
				id = WtWSMS_foederati.7 # Pick a territory to promise
			}
		}
	}
	option = { 	# Break negotiations
		name = WtWSMS_foederati.9.b
		ai_chance = {
			#Option B modifiers
		}
		event_target:barbarian_negotiator = {
			character_event = { 
				id = WtWSMS_foederati.12 # Negotiations break
				days = 7
				random = 3
			}
		}
		event_target:roman_negotiator = {
			character_event = { 
				id = WtWSMS_foederati.12 # Negotiations break
			}
		}
	}
}
	
# Makes the offer to settle outside it
character_event = {
    id = WtWSMS_foederati.10
	desc = WtWSMS_foederati.10.desc
	picture = GFX_evt_emissary
	
    is_triggered_only = yes

	option = { # Barbarian accepts
		name = WtWSMS_foederati.10.a
		ai_chance = {
			#Option A modifiers
		}
		event_target:barbarian_negotiator = {
			character_event = { 				
				id = WtWSMS_foederati.13 # Negotiations successful, with both parties having accepted
			}
		}
		event_target:roman_negotiator = {
			character_event = { 
				id = WtWSMS_foederati.13 # Negotiations successful, with both parties having accepted
				days = 7
				random = 3
			}
		}
	}
	option = { # Barbarian refuses
		name = WtWSMS_foederati.10.b
		ai_chance = {
			#Option B modifiers
		}
		event_target:barbarian_negotiator = {
			character_event = { 
				id = WtWSMS_foederati.12 # Negotiations break
			}
		}
		event_target:roman_negotiator = {
			character_event = { 
				id = WtWSMS_foederati.12 # Negotiations break
				days = 7
				random = 3
			}
		}
	}
}
	
# Barbarian negotiator does not wish to settle in the empire
character_event = {
    id = WtWSMS_foederati.11
	desc = WtWSMS_foederati.11.desc
	picture = GFX_evt_emissary
	
    is_triggered_only = yes

	option = { # Accept it 
		name = WtWSMS_foederati.11.a
		ai_chance = {
			#Option A modifiers
		}
		event_target:roman_negotiator = {
			set_character_flag = settling_outside_empire_flag
		}		
		event_target:barbarian_negotiator = {
			character_event = { 				
				id = WtWSMS_foederati.13 # Negotiations successful, with both parties having accepted
				days = 7
				random = 3
			}
		}
		event_target:roman_negotiator = {
			character_event = { 
				id = WtWSMS_foederati.13 # Negotiations successful, with both parties having accepted
			}
		}	
	}
	option = { # Refuse it, offer a territory to settle within the empire
		name = WtWSMS_foederati.11.b
		ai_chance = {
			#Option B modifiers
		}
		event_target:roman_negotiator = {
			character_event = { 
				id = WtWSMS_foederati.4 # Pick a territory to offer
			}			
			set_character_flag = offered_territory_flag
		}
	}
	option = { # Refuse it, promise a territory to settle within the empire
		name = WtWSMS_foederati.11.c
		ai_chance = {
			#Option C modifiers
		}
		event_target:roman_negotiator = {
			character_event = { 
				id = WtWSMS_foederati.7 # Pick a territory to promise
			}
			set_character_flag = promised_territory_to_@FROM_flag
		}
	}
}

# Negotiations break
character_event = {
    id = WtWSMS_foederati.12
	desc = WtWSMS_foederati.12.desc
	picture = GFX_evt_emissary
	
    is_triggered_only = yes
	
	immediate = {
		event_target:roman_negotiator = {
			opinion = {
				modifier = opinion_broken_foederati_negotiations
				who = event_target:barbarian_negotiator
			}
		}
		event_target:barbarian_negotiator = {
			opinion = {
				modifier = opinion_broken_foederati_negotiations
				who = event_target:roman_negotiator
			}
		}
		if = { 
			limit = { 
				has_character_flag = offered_territory_flag
			}
			clr_character_flag = offered_territory_flag
		}
		if = { 
			limit = { 
				has_character_flag = promised_territory_to_@FROM_flag
			}
			clr_character_flag = promised_territory_to_@FROM_flag
		}
		if = { 
			limit = { 
				has_character_flag = promised_territory_to_@ROOT_flag
			}
			clr_character_flag = promised_territory_to_@ROOT_flag
		}
		if = { 
			limit = { 
				has_character_flag = settling_outside_empire_flag
			}
			clr_character_flag = settling_outside_empire_flag
		}
	}

	option = { # OK
		name = WtWSMS_foederati.12.a
		ai_chance = {
			#Option A modifiers
		}
		# Nothing in particular for now
	}
	option = { # Romans declare war upon Barbarians impose their demands after failed negotiations
		name = WtWSMS_foederati.12.b
		trigger = {
			has_romance_culture_trigger = yes # Is Roman
		}
		ai_chance = {
			#Option B modifiers
		}
		# War with Barbarian
	}
	option = { # Barbarians declare war upon Romans to impose their demands after failed negotiations
		name = WtWSMS_foederati.12.c		
		trigger = {
			any_neighbor_independent_ruler = { # Is Barbarian
				AND = {
					primary_title = { higher_tier_than = DUKE }
					has_romance_culture_trigger = yes
				}
			}
		}
		ai_chance = {
			#Option C modifiers
		}
		# War with Romans
	}
}

# Negotiations successful, with both parties having accepted
character_event = {
    id = WtWSMS_foederati.13
	desc = WtWSMS_foederati.13.desc
	picture = GFX_evt_emissary
	
    is_triggered_only = yes
	
	immediate = {
		event_target:roman_negotiator = {
			opinion = {
				modifier = opinion_successful_foederati_negotiations
				who = event_target:barbarian_negotiator
			}
		}
		event_target:barbarian_negotiator = {
			opinion = {
				modifier = opinion_successful_foederati_negotiations
				who = event_target:roman_negotiator
			}
		}
	}

	option = { # Excellent!
		name = WtWSMS_foederati.13.a
		ai_chance = {
			#Option A modifiers
		}
		event_target:roman_negotiator = {
			character_event = { 
				id = WtWSMS_foederati.14 # Becomes foederati after sucessful negotiations and gets land
			}
		}
	}
}

# Becomes foederati after sucessful negotiations and gets land
character_event = {
    id = WtWSMS_foederati.14
	desc = WtWSMS_foederati.14.desc
	picture = GFX_evt_emissary
	
    is_triggered_only = yes
	
	immediate = {
		event_target:roman_negotiator = {
			make_tributary = {
				who = event_target:barbarian_negotiator
				tributary_type = foederati
			}
			custom_tooltip = { text = become_foederati_barbarian_effect_TT }
			event_target:barbarian_negotiator = {
				sound_effect = grace_gain
				add_character_modifier = {
					name = become_foederati_timer
					duration = 3600
				}
			}
		}
	}

	option = { # Welcome!
		name = WtWSMS_foederati.14.a
		trigger = {
			has_character_flag = offered_territory_flag
		}
		ai_chance = {
			#Option A modifiers
		}
		event_target:barbarian_negotiator = {
			any_realm_province = { # Give away old lands
				limit = {
					has_province_flag = foederati_give_away
				}
				county = {
					create_character = {
						random_traits = yes
						dynasty = none
						religion = PREV
						culture = PREV
						female = no
						age = 25
						trait = peasant_leader
					}
					new_character = {
						usurp_title_plus_barony_if_unlanded = PREV
						set_defacto_liege = THIS
						set_truce = {
							who = ROOT
							years = 10
						}
						ROOT = {
							set_truce = {
								who = PREV
								years = 10
							}
						}
					}
				}
				clr_province_flag = foederati_give_away
			}
			event_target:offered_territory = { # Grant offered land
				any_de_jure_vassal_title = { # Vassal county of the duchy
					limit = {
						tier = COUNT
					}
					grant_title	= event_target:barbarian_negotiator
				}
			}
			create_title = { # Create new titular duchy
				tier = DUKE
				landless = no
				temporary = no
				custom_created = yes
				culture = event_target:barbarian_negotiator
				holder = event_target:barbarian_negotiator
				name = "FOEDERATI_DUCHY"
				base_title = PREV
			}
			if = { # Change government from tribal to feudal
				limit = {
					is_tribal = yes
				}
				set_government_type	= feudal_government
			}
			clr_character_flag = offered_territory_flag
			clear_event_target = offered_territory
		}
	}
	option = { # All in due time...
		name = WtWSMS_foederati.14.b
		trigger = {
			has_character_flag = promised_territory_to_@barbarian_negotiator_flag # Use event target in dynamic flag
		}
		ai_chance = {
			#Option B modifiers
		}
		event_target:barbarian_negotiator = { 
			character_event = { 				
				id = WtWSMS_foederati.15 # Barbarian reminded of promise
				days = 1825 # Five years
			}
		}
		# Custom tooltip to explain new event in a few years to follow up the promise
	}
	option = { # Protect the border
		name = WtWSMS_foederati.14.c
		trigger = {
			has_character_flag = settling_outside_empire_flag
		}
		ai_chance = {
			#Option C modifiers
		}
		clr_character_flag = settling_outside_empire_flag
		# Nothing else for now
		# Change government?
	}
}

# Barbarian reminded of promise
character_event = {
    id = WtWSMS_foederati.15
	desc = WtWSMS_foederati.15.desc
	picture = GFX_evt_emissary

    is_triggered_only = yes
	
	option = { # Ask for promised territory
		name = WtWSMS_foederati.15.a
		ai_chance = {
			#Option A modifiers
		}
		event_target:roman_negotiator = {
			character_event = { 				
				id = WtWSMS_foederati.16 # Negotiations successful, with both parties having accepted
				days = 7
				random = 3
			}
		}
		#Option A effects
	}
	option = { # Wait more, reloads same event after five years
		name = WtWSMS_foederati.15.b
		trigger = {
			ai = no # Too easy otherwise to trick AI
		}
		ai_chance = {
			#Option B modifiers
		}
		event_target:barbarian_negotiator = { 
			character_event = { 				
				id = WtWSMS_foederati.15 # Barbarian reminded of promise
				days = 1825 # Five years
			}
		}
	}
}

# Barbarian reminds Roman of promise
character_event = {
    id = WtWSMS_foederati.16
	desc = WtWSMS_foederati.16.desc
	picture = GFX_evt_emissary
	
    is_triggered_only = yes

	option = { # Grant promised territory
		name = WtWSMS_foederati.16.a
		ai_chance = {
			#Option A modifiers
		}
		event_target:barbarian_negotiator = {
			any_realm_province = { # Give away old lands
				limit = {
					has_province_flag = foederati_give_away
				}
				county = {
					create_character = {
						random_traits = yes
						dynasty = none
						religion = PREV
						culture = PREV
						female = no
						age = 25
						trait = peasant_leader
					}
					new_character = {
						usurp_title_plus_barony_if_unlanded = PREV
						set_defacto_liege = THIS
						set_truce = {
							who = ROOT
							years = 10
						}
						ROOT = {
							set_truce = {
								who = PREV
								years = 10
							}
						}
					}
				}
				clr_province_flag = foederati_give_away
			}
			event_target:offered_territory = { # Grant offered land
				any_de_jure_vassal_title = { # Vassal county of the duchy
					limit = {
						tier = COUNT
					}
					grant_title	= event_target:barbarian_negotiator
				}
			}
			create_title = { # Create new titular duchy
				tier = DUKE
				landless = no
				temporary = no
				custom_created = yes
				culture = event_target:barbarian_negotiator
				holder = event_target:barbarian_negotiator
				name = "FOEDERATI_DUCHY"
				base_title = PREV
			}
			if = { # Change government from tribal to feudal
				limit = {
					is_tribal = yes
				}
				set_government_type	= feudal_government
			}
			clr_character_flag = promised_territory_to_@FROM_flag
			clear_event_target = promised_territory
		}
	}
	option = { # Attempt to delay further
		name = WtWSMS_foederati.16.b
		ai_chance = {
			#Option B modifiers
		}
		# Barbarian gets to react 
	}
	option = { # War to impose concessions
		name = WtWSMS_foederati.X.c
		ai_chance = {
			#Option C modifiers
		}
		#Option C effects
		# War with Barbarian
	}
}

# Liberate tributary CB
# Make tributary
# Migratory invasion
# New specific make foederati CB?
# Make sure to destroy existant title

# Event for Romans upon enforcing demands on the barbarians to force them into foederati status

# Event for Barbarians upon white peace with Romans to allow for opening negotiations
	# In this case the Barbarians aren't necessarily neighbours with the Romans, could that pose a problem?